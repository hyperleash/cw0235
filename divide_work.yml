- name: Initialize an empty list for line ranges
  set_fact:
    line_ranges: []

- name: Calculate line ranges
  set_fact:
    line_ranges: "{{ line_ranges + [{'host': item, 'start_line': start_line, 'end_line': end_line if not ansible_loop.last else hostvars[item].line_count}] }}"
  vars:
    start_line: "{{ ((prev_end_line | default(0)) | int) + 1 }}"
    end_line: "{{ (start_line | int) + ((((hostvars[item].ansible_processor_vcpus | int) - 1) * (hostvars[item].line_count | int) / (hostvars[item].total_threads | int)) | round(0, 'floor')) - 1 }}"
    prev_end_line: "{{ line_ranges | map(attribute='end_line') | last }}"
  loop: "{{ groups['cluster_nodes'] + groups['client'] }}"
  loop_control:
    extended: yes
  run_once: true
