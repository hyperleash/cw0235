#install python and ansible on host before doing any of this
- name: Dividing work
  hosts: cluster_nodes:client
  become: yes
  roles:
    - divide_work

- name: Calculate line ranges for each node
  hosts: localhost
  gather_facts: no
  vars:
    total_lines: 6000 # Total number of lines
    total_threads: 7 # Total number of threads across all nodes
  tasks:
    - name: Initialize an empty list for line ranges
      set_fact:
        line_ranges: []

    - name: Calculate line ranges
      set_fact:
        line_ranges: "{{ line_ranges + [{'host': item, 'start_line': start_line, 'end_line': end_line if not ansible_loop.last else total_lines}] }}"
      vars:
        start_line: "{{ ((prev_end_line | default(0)) | int) + 1 }}"
        end_line: "{{ (start_line | int) + ((((hostvars[item].ansible_processor_vcpus | int) - 1) * total_lines / total_threads) | round(0, 'floor')) - 1 }}"
        prev_end_line: "{{ line_ranges | map(attribute='end_line') | last }}"
      loop: "{{ groups['cluster_nodes'] + groups['client'] }}"
      loop_control:
        extended: yes
      run_once: true

- name: Distribute line ranges to nodes
  hosts: cluster_nodes:client
  gather_facts: no
  tasks:
    - name: Set line range for each node
      set_fact:
        node_line_start: "{{ host_line_range.start_line }}"
        node_line_end: "{{ host_line_range.end_line }}"
      vars:
        host_line_range: "{{ hostvars['localhost'].line_ranges | selectattr('host', 'equalto', inventory_hostname) | first }}"
    - name: Display line ranges for each node
      debug:
        msg: "Node {{ inventory_hostname }} processes lines from {{ hostvars[inventory_hostname].node_line_start }} to {{ hostvars[inventory_hostname].node_line_end }}"



- name: Generate Key on the localhost
  hosts: localhost
  become: yes
  roles:
    - key_generator

- name: Distribute keys to cluster nodes
  hosts: cluster_nodes:client
  become: yes
  roles:
    - key_distributor

- name: prepare disk on cluster nodes
  hosts: cluster_nodes:client
  roles:
    - mount_disk

- name: install dependencies
  hosts: cluster_nodes:client
  become: yes
  roles:
    - install_dependencies

- name: Download db on the client
  hosts: client
  become: yes
  roles:
    - data

- name: Distribute the file to other clients
  hosts: cluster_nodes
  roles:
    - data_distributer
  vars:
    src_file: "/home/ec2-user/data/weights.tar.gz"
    dest_dir: "/home/ec2-user/data/"
    delegate: "10.0.7.13"

- name: Distribute scripts to other clients
  hosts: cluster_nodes:client
  become: yes
  roles:
    - script_distributer
  vars:
    src_file: "/home/ec2-user/cw0235/scripts"
    dest_dir: "/home/ec2-user/"
  
- name: Distribute full list of experiment ids
  hosts: cluster_nodes:client
  become: yes
  roles:
    - script_distributer
  vars:
    src_file: "/home/ec2-user/cw0235/experiment_ids.txt"
    dest_dir: "/home/ec2-user/scripts/experiment_ids.txt"
  

